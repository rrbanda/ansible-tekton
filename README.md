# ğŸš€ Ansible Tekton CI/CD Pipeline

This project demonstrates a full CI/CD pipeline on OpenShift using **Tekton Pipelines** to lint and promote Ansible playbooks through Git branches (`dev â†’ stage â†’ prod`). It includes automated PR creation and lint summary reports.

---

## ğŸ“‹ Features

- âœ… Run `ansible-lint` on all playbooks in `samples/`
- âœ… Generate a `lint-summary.md` with a test matrix
- âœ… Promote passing playbooks to a `promoted/` folder
- âœ… Create PRs to `stage` (auto-merged) or `prod` (manual)
- âœ… Trigger pipeline manually or via GitHub webhook

---

## âš™ï¸ Prerequisites

### ğŸ”¸ OpenShift Pipelines (Tekton) Setup

Install the OpenShift Pipelines Operator:

1. Navigate to **OperatorHub** in the OpenShift Console
2. Search for `Red Hat OpenShift Pipelines`
3. Install in your project (or cluster-wide)
4. Confirm CRDs like `Pipeline`, `Task`, `EventListener` exist:
   ```bash
   oc get crd | grep tekton
   ```

### ğŸ”¸ Create a Project

```bash
oc new-project instructlab
```

### ğŸ”¸ GitHub Token Secret

Generate a [Personal Access Token (classic)](https://github.com/settings/tokens) with `repo` and `workflow` scopes, then create the secret:

```bash
oc create secret generic github-creds \
  --from-literal=token=<your-token-here> \
  -n instructlab
```

---

## ğŸ—‚ Directory Structure

```bash
ansible-tekton/
â”œâ”€â”€ samples/                        # Playbooks (good + bad examples)
â”œâ”€â”€ promoted/                      # Generated by pipeline
â”œâ”€â”€ tasks/                         # Tekton tasks (e.g., promote-playbook)
â”œâ”€â”€ triggers/                      # Webhook triggers (optional)
â”œâ”€â”€ pvc-template.yaml              # Shared workspace volume
â”œâ”€â”€ ansible-lint-pipeline.yaml     # Main pipeline
â”œâ”€â”€ pipelinerun-*.yaml             # Manual test runs
â””â”€â”€ README.md
```

---

## ğŸ”§ Deploy the Pipeline

```bash
# Set project
oc project instructlab

# Create PVC
kubectl apply -f pvc-template.yaml

# Create Tasks
kubectl apply -f tasks/

# Create Pipeline
kubectl apply -f ansible-lint-pipeline.yaml
```

---

## ğŸš€ Run the Pipeline

### â¤ Manually Promote from `dev` to `stage`:
```bash
kubectl apply -f pipelinerun-promote-dev-to-stage.yaml
```

### â¤ Manually Promote from `stage` to `prod`:
```bash
kubectl apply -f pipelinerun-promote-stage-to-prod.yaml
```

Monitor logs:
```bash
tkn pipelinerun logs promote-dev-to-stage -f -n instructlab
```

---

## ğŸ” Set Up GitHub Webhook (Optional)

### â¤ Expose Listener
```bash
oc get route el-ansible-lint-listener -n instructlab
```

Use the returned URL in your GitHub repo under **Settings > Webhooks**:
- **Payload URL**: `http://<your-listener-route>`
- **Content type**: `application/json`
- **Events**: `Just the push event`

### â¤ Apply Trigger Resources

```bash
kubectl apply -f triggers/
```

The webhook triggers the pipeline when a push is made to the `dev` branch.

---

## âœ… Promotion Rules

| Source | Target | PR Title                             | Merge Type      |
|--------|--------|--------------------------------------|-----------------|
| dev    | stage  | Auto PR: Promote playbooks (x.yml)   | âœ… Auto-merged   |
| stage  | prod   | Promote to Prod: Final review (x.yml)| âŒ Manual review|

---

## ğŸ“ Output Artifacts

Each PR includes:
- `promoted/*.yml` â€” clean playbooks
- `lint-summary.md` â€” lint pass/fail matrix

Example:
```markdown
# Lint Summary Report

| Playbook          | Status   |
|-------------------|----------|
| install_nginx.yml | âœ… Passed |
| test_fail.yml     | âŒ Failed |

_Auto-generated by Tekton at 2025-04-22_
```

---

## ğŸ¤ Contributions

Feel free to fork, extend or submit PRs to add:
- Slack notifications
- GitHub status checks
- Multi-repo promotion support

---

## ğŸ“ References

- [OpenShift Pipelines Docs](https://docs.openshift.com/container-platform/latest/cicd/pipelines/)
- [Ansible Lint Rules](https://ansible-lint.readthedocs.io/)
- [Tekton Triggers GitHub Example](https://github.com/tektoncd/triggers)

---
# Trigger test
# Trigger test
