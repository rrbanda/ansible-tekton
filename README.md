# 🚀 Ansible Tekton CI/CD Pipeline

This project demonstrates a full CI/CD pipeline on OpenShift using **Tekton Pipelines** to lint and promote Ansible playbooks through Git branches (`dev → stage → prod`). It includes automated PR creation and lint summary reports.

---

## 📋 Features

- ✅ Run `ansible-lint` on all playbooks in `samples/`
- ✅ Generate a `lint-summary.md` with a test matrix
- ✅ Promote passing playbooks to a `promoted/` folder
- ✅ Create PRs to `stage` (auto-merged) or `prod` (manual)
- ✅ Trigger pipeline manually or via GitHub webhook

---

## ⚙️ Prerequisites

### 🔸 OpenShift Pipelines (Tekton) Setup

Install the OpenShift Pipelines Operator:

1. Navigate to **OperatorHub** in the OpenShift Console
2. Search for `Red Hat OpenShift Pipelines`
3. Install in your project (or cluster-wide)
4. Confirm CRDs like `Pipeline`, `Task`, `EventListener` exist:
   ```bash
   oc get crd | grep tekton
   ```

### 🔸 Create a Project

```bash
oc new-project instructlab
```

### 🔸 GitHub Token Secret

Generate a [Personal Access Token (classic)](https://github.com/settings/tokens) with `repo` and `workflow` scopes, then create the secret:

```bash
oc create secret generic github-creds \
  --from-literal=token=<your-token-here> \
  -n instructlab
```

---

## 🗂 Directory Structure

```bash
ansible-tekton/
├── samples/                        # Playbooks (good + bad examples)
├── promoted/                      # Generated by pipeline
├── tasks/                         # Tekton tasks (e.g., promote-playbook)
├── triggers/                      # Webhook triggers (optional)
├── pvc-template.yaml              # Shared workspace volume
├── ansible-lint-pipeline.yaml     # Main pipeline
├── pipelinerun-*.yaml             # Manual test runs
└── README.md
```

---

## 🔧 Deploy the Pipeline

```bash
# Set project
oc project instructlab

# Create PVC
kubectl apply -f pvc-template.yaml

# Create Tasks
kubectl apply -f tasks/

# Create Pipeline
kubectl apply -f ansible-lint-pipeline.yaml
```

---

## 🚀 Run the Pipeline

### ➤ Manually Promote from `dev` to `stage`:
```bash
kubectl apply -f pipelinerun-promote-dev-to-stage.yaml
```

### ➤ Manually Promote from `stage` to `prod`:
```bash
kubectl apply -f pipelinerun-promote-stage-to-prod.yaml
```

Monitor logs:
```bash
tkn pipelinerun logs promote-dev-to-stage -f -n instructlab
```

---

## 🔁 Set Up GitHub Webhook (Optional)

### ➤ Expose Listener
```bash
oc get route el-ansible-lint-listener -n instructlab
```

Use the returned URL in your GitHub repo under **Settings > Webhooks**:
- **Payload URL**: `http://<your-listener-route>`
- **Content type**: `application/json`
- **Events**: `Just the push event`

### ➤ Apply Trigger Resources

```bash
kubectl apply -f triggers/
```

The webhook triggers the pipeline when a push is made to the `dev` branch.

---

## ✅ Promotion Rules

| Source | Target | PR Title                             | Merge Type      |
|--------|--------|--------------------------------------|-----------------|
| dev    | stage  | Auto PR: Promote playbooks (x.yml)   | ✅ Auto-merged   |
| stage  | prod   | Promote to Prod: Final review (x.yml)| ❌ Manual review|

---

## 📝 Output Artifacts

Each PR includes:
- `promoted/*.yml` — clean playbooks
- `lint-summary.md` — lint pass/fail matrix

Example:
```markdown
# Lint Summary Report

| Playbook          | Status   |
|-------------------|----------|
| install_nginx.yml | ✅ Passed |
| test_fail.yml     | ❌ Failed |

_Auto-generated by Tekton at 2025-04-22_
```

---

## 🤝 Contributions

Feel free to fork, extend or submit PRs to add:
- Slack notifications
- GitHub status checks
- Multi-repo promotion support

---

## 📎 References

- [OpenShift Pipelines Docs](https://docs.openshift.com/container-platform/latest/cicd/pipelines/)
- [Ansible Lint Rules](https://ansible-lint.readthedocs.io/)
- [Tekton Triggers GitHub Example](https://github.com/tektoncd/triggers)

---
# Trigger test
# Trigger test
