apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: promote-playbook
spec:
  params:
    - name: target-repo-url
      type: string
    - name: pr-base-branch
      type: string
    - name: target-branch
      type: string
      default: stage
  workspaces:
    - name: shared
  steps:
    - name: promote
      image: debian:bullseye
      workingDir: $(workspaces.shared.path)
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-creds
              key: token
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "📦 Installing dependencies..."
        apt-get update -qq
        apt-get install -y git curl jq tar

        echo "⬇️ Installing gh CLI..."
        GH_VERSION=$(curl -s https://api.github.com/repos/cli/cli/releases/latest | jq -r .tag_name)
        curl -sSL https://github.com/cli/cli/releases/download/${GH_VERSION}/gh_${GH_VERSION#v}_linux_amd64.tar.gz -o gh.tgz
        tar -xzf gh.tgz
        mv gh_${GH_VERSION#v}_linux_amd64/bin/gh /usr/local/bin/
        chmod +x /usr/local/bin/gh

        echo "🔐 Cloning repo into clean ./repo directory..."
        rm -rf repo && mkdir repo
        cd repo

        git config --global user.email "tekton@example.com"
        git config --global user.name "tekton"
        git clone https://oauth2:${GITHUB_TOKEN}@github.com/rrbanda/ansible-tekton.git .

        echo "🔄 Checking out $(params.pr-base-branch)..."
        git checkout "$(params.pr-base-branch)"
        git pull origin "$(params.pr-base-branch)"

        BRANCH=promote-$(date +%s)
        git checkout -b $BRANCH

        echo "📥 Copying playbooks that passed lint..."
        mkdir -p promoted
        cp -v $(workspaces.shared.path)/passed/*.yml promoted/ || echo "No passed playbooks"

        echo "🧾 Generating lint-summary.md..."
        {
          echo "# Lint Summary Report"
          echo ""
          echo "| Playbook | Status |"
          echo "|----------|--------|"
          for file in $(workspaces.shared.path)/passed/*.yml; do
            [ -e "$file" ] || continue
            fname=$(basename "$file")
            echo "| $fname | ✅ Passed |"
          done
          for file in $(workspaces.shared.path)/failed/*.yml; do
            [ -e "$file" ] || continue
            fname=$(basename "$file")
            echo "| $fname | ❌ Failed |"
          done
          echo ""
          echo "_Auto-generated by Tekton at $(date)_"
        } > lint-summary.md

        git add promoted/ lint-summary.md
        git commit -m "Promoted clean playbooks + lint summary"
        git push https://oauth2:${GITHUB_TOKEN}@github.com/rrbanda/ansible-tekton.git $BRANCH

        echo "📤 Creating PR to $(params.pr-base-branch)..."
        gh auth setup-git
        PR_TITLE="Promote to $(params.pr-base-branch): Lint-passed playbooks"
        gh pr create \
          --base "$(params.pr-base-branch)" \
          --head "$BRANCH" \
          --title "$PR_TITLE" \
          --body "✅ Playbooks passed lint.\n📝 lint-summary.md included.\nAuto-generated by Tekton."

        if [ "$(params.target-branch)" = "stage" ]; then
          echo "✅ Attempting auto-merge for stage..."
          PR_URL=$(gh pr list --head "$BRANCH" --json url -q '.[0].url')
          gh pr merge "$PR_URL" --merge --admin || echo "⚠️ Auto-merge failed"
        else
          echo "🔒 Manual review required for prod."
        fi
