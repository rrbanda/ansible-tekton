apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: sync-prod-to-main
spec:
  workspaces:
    - name: shared
  steps:
    - name: sync
      image: debian:bullseye
      workingDir: $(workspaces.shared.path)
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-creds
              key: token
      script: |
        #!/bin/bash
        set -e

        echo "📦 Installing dependencies..."
        apt-get update -qq
        apt-get install -y git curl jq

        echo "🔐 Cloning repo..."
        git config --global user.email "tekton@example.com"
        git config --global user.name "tekton"
        git clone https://oauth2:${GITHUB_TOKEN}@github.com/rrbanda/ansible-tekton.git .
        git checkout prod

        echo "🔁 Syncing prod → main..."
        git checkout -B main
        git merge prod --no-edit || echo "⚠️ Merge completed with conflicts, please resolve manually"

        echo "🚀 Pushing updated main branch..."
        git push https://oauth2:${GITHUB_TOKEN}@github.com/rrbanda/ansible-tekton.git main
